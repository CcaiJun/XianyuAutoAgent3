# 闲鱼自动回复 Web UI 管理界面

## 功能介绍

本Web UI为闲鱼自动回复机器人提供了一个功能完整的管理界面，包含以下功能：

### 1. 系统监控与控制
- **实时状态监控**：显示主程序运行状态（运行中/已停止/启动中）
- **心跳检测**：监控WebSocket连接心跳状态，确保连接稳定
- **进程管理**：一键启动/停止主程序
- **状态刷新**：手动或自动刷新系统状态

### 2. 实时日志查看
- **实时日志显示**：通过WebSocket实时推送程序日志
- **日志分类**：支持INFO、ERROR、WARNING、DEBUG等不同级别日志的颜色区分
- **自动滚动**：可开启/关闭日志自动滚动到底部
- **日志清空**：一键清空当前显示的日志
- **日志缓存**：保存最近1000条日志记录

### 3. 提示词管理
- **文件选择**：下拉选择prompts文件夹中的提示词文件
- **在线编辑**：直接在网页中编辑提示词内容
- **实时保存**：修改后可直接保存到文件
- **支持的提示词类型**：
  - `default_prompt.txt` - 默认回复提示词
  - `price_prompt.txt` - 价格相关提示词
  - `classify_prompt.txt` - 分类提示词
  - `tech_prompt.txt` - 技术相关提示词

### 4. 环境变量配置
- **可视化配置**：以表单形式配置环境变量
- **常用配置项**：
  - `COOKIES_STR` - 闲鱼登录Cookie（必需）
  - `TOGGLE_KEYWORDS` - 人工接管切换关键词
  - `OPENAI_API_KEY` - OpenAI API密钥（必需）
  - `OPENAI_BASE_URL` - OpenAI API基础URL
- **自动保存**：修改后可直接保存到.env文件

## 安装与使用

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

新增的依赖包括：
- `flask==2.3.3` - Web框架
- `flask-socketio==5.3.6` - WebSocket支持
- `psutil==5.9.6` - 进程管理

### 2. 启动Web UI

```bash
python web_ui.py
```

启动后访问：http://localhost:5000

### 3. 配置环境变量

首次使用需要在"环境变量"选项卡中配置：

1. **COOKIES_STR**：从浏览器复制闲鱼登录后的Cookie字符串
2. **OPENAI_API_KEY**：您的OpenAI API密钥
3. **OPENAI_BASE_URL**：OpenAI API地址（可选，默认为官方地址）
4. **TOGGLE_KEYWORDS**：人工接管关键词（可选，默认为"。"）

### 4. 管理提示词

在"提示词"选项卡中：

1. 从下拉菜单选择要编辑的提示词文件
2. 在文本框中编辑内容
3. 点击"保存提示词"按钮保存修改

## 界面说明

### 顶部导航栏
- 显示应用标题和当前系统状态指示器
- 状态指示器颜色：绿色（运行中）、红色（已停止）、黄色（启动中）

### 控制面板
- **启动程序**：启动main.py主程序
- **停止程序**：停止正在运行的主程序
- **刷新状态**：手动刷新系统状态
- **进程状态**：显示当前进程状态
- **心跳状态**：显示WebSocket心跳状态
- **最后心跳时间**：显示最近一次心跳的时间

### 日志区域
- 实时显示程序运行日志
- 不同级别的日志以不同颜色显示
- 支持自动滚动和手动滚动模式
- 可清空当前显示的日志

### 配置区域
- **提示词选项卡**：管理AI回复的提示词模板
- **环境变量选项卡**：配置系统运行所需的环境变量

## 快捷键

- `Ctrl + S`：保存当前编辑的提示词或环境变量
- `Ctrl + R`：刷新系统状态

## 注意事项

1. **首次使用**：请确保先配置好COOKIES_STR和OPENAI_API_KEY
2. **Cookie更新**：闲鱼Cookie有时效性，如遇到连接问题请更新Cookie
3. **进程管理**：建议通过Web界面启动/停止程序，避免手动kill进程
4. **提示词修改**：修改提示词后程序会立即生效，无需重启
5. **环境变量修改**：修改环境变量后需要重启程序才能生效

## 安全说明

- Web UI默认绑定到所有网络接口（0.0.0.0:5000）
- 如在生产环境使用，建议配置防火墙规则限制访问
- Cookie和API密钥等敏感信息会保存在.env文件中，请注意保护

## 故障排除

### 程序无法启动
1. 检查.env文件中的COOKIES_STR是否正确
2. 检查OPENAI_API_KEY是否有效
3. 查看日志输出了解具体错误信息

### WebSocket连接问题
1. 检查网络连接
2. 查看心跳状态是否正常
3. 尝试重启程序

### 提示词不生效
1. 确认文件保存成功
2. 检查提示词语法是否正确
3. 查看日志是否有相关错误

## 技术架构

- **后端**：Flask + Flask-SocketIO
- **前端**：Bootstrap 5 + JavaScript
- **通信**：RESTful API + WebSocket
- **进程管理**：subprocess + psutil
- **日志处理**：实时捕获 + 内存缓冲

## 开发说明

如需二次开发，主要文件结构：

```
├── web_ui.py              # Flask应用主文件
├── templates/
│   └── index.html         # 主页面模板
├── static/
│   ├── css/style.css      # 样式文件
│   └── js/app.js          # JavaScript逻辑
├── prompts/               # 提示词文件夹
└── main.py               # 原始主程序
``` 